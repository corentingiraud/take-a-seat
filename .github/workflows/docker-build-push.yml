name: Build & Deploy

on:
  push:
    branches: [ "main" ]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/docker-build-push.yml"
  pull_request:
    branches: [ "main" ]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/docker-build-push.yml"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  OWNER: corentingiraud
  IMAGE: take-a-seat
  PLATFORMS: linux/amd64

jobs:
  version:
    name: bump version
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}

    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: bump patch version
        id: bump
        run: |
          LATEST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -n 1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
          fi

          MAJOR=$(echo "$LATEST_TAG" | sed 's/v//' | cut -d. -f1)
          MINOR=$(echo "$LATEST_TAG" | sed 's/v//' | cut -d. -f2)
          PATCH=$(echo "$LATEST_TAG" | sed 's/v//' | cut -d. -f3)

          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: create and push tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag ${{ steps.bump.outputs.new_version }}
          git push origin ${{ steps.bump.outputs.new_version }}

  docker:
    name: build & push (${{ matrix.service.id }})
    runs-on: ubuntu-latest
    needs: version
    if: always() && (needs.version.result == 'success' || needs.version.result == 'skipped')

    strategy:
      fail-fast: false
      matrix:
        service:
          - id: backend
            context: ./backend
            file: ./backend/Dockerfile
            tag_suffix: backend-latest
          - id: frontend
            context: ./frontend
            file: ./frontend/Dockerfile
            tag_suffix: frontend-latest

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: set up docker buildx
        uses: docker/setup-buildx-action@v3

      - name: log in to ghcr
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: extract docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE }}
          tags: |
            type=raw,value=${{ matrix.service.tag_suffix }}
            type=raw,value=${{ matrix.service.id }}-${{ github.sha }}
            type=raw,value=${{ matrix.service.id }}-${{ needs.version.outputs.new_version }},enable=${{ needs.version.outputs.new_version != '' }}
            type=ref,event=tag

      - name: build & push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.file }}
          platforms: ${{ env.PLATFORMS }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          sbom: false

  deploy:
    name: deploy to production
    runs-on: ubuntu-latest
    needs: docker
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /etc/caddy
            sudo cp Caddyfile.maintenance Caddyfile
            sudo systemctl restart caddy

            cd /home/ubuntu/take-a-seat
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d

            cd /etc/caddy
            sudo cp Caddyfile.prod Caddyfile
            sudo systemctl restart caddy

            docker image prune -f
